# Create User API - Field Reference and Behavior

## Overview

The `POST /create` endpoint creates a new user in the system, handling both Keycloak authentication service integration and database persistence. The API supports complex user creation scenarios including tenant-role-cohort mappings, automatic member assignments, and custom field validations.

## API Endpoint Details

- **Method**: `POST`
- **Path**: `/create`
- **Content-Type**: `application/json`
- **Authentication**: Optional (JWT Guard commented out)
- **API ID**: `api.user.create`

## Headers

| Header | Required | Type | Description | Example |
|--------|----------|------|-------------|---------|
| `academicyearid` | Optional | UUID | Academic Year ID for cohort assignments | `123e4567-e89b-12d3-a456-426614174000` |
| `Authorization` | Optional | String | JWT Bearer token for user context | `Bearer eyJhbGciOiJIUzI1NiIs...` |

## Request Body Structure

### Core User Fields

#### ðŸ”’ **Mandatory Fields**

| Field | Type | Validation | Description |
|-------|------|------------|-------------|
| `username` | String | `@IsNotEmpty()` | Unique username (converted to lowercase) |
| `firstName` | String | `@IsString()`, `@Length(1, 50)` | User's first name |
| `lastName` | String | `@IsString()`, `@Length(1, 50)` | User's last name |
| `gender` | Enum | `@IsEnum(["male", "female", "transgender"])` | User's gender |
| `password` | String | `@IsNotEmpty()` | Password for Keycloak authentication |
| `tenantCohortRoleMapping` | Array | `@ValidateNested()` | Array of tenant-role-cohort mappings |

#### âœ… **Optional Fields**

| Field | Type | Validation | Description | Default |
|-------|------|------------|-------------|---------|
| `middleName` | String | `@IsOptional()`, `@Length(0, 50)` | User's middle name | `null` |
| `dob` | String | `@IsDateString()`, `@NotInFuture()` | Date of birth (YYYY-MM-DD) | `null` |
| `mobile` | String | Custom validation (10 digits) | Mobile number | `null` |
| `email` | String | Email format validation | Email address | `null` |
| `district` | String | No validation | District information | `null` |
| `state` | String | No validation | State information | `null` |
| `address` | String | No validation | Address information | `null` |
| `pincode` | String | No validation | Postal code | `null` |

#### ðŸ§ª **Auto-Generated/System Fields**

| Field | Type | Description | Generated By |
|-------|------|-------------|--------------|
| `userId` | UUID | Primary key | Keycloak response |
| `enrollmentId` | String | Auto-generated enrollment ID | System |
| `createdAt` | Timestamp | Creation timestamp | Database |
| `updatedAt` | Timestamp | Last update timestamp | Database |
| `createdBy` | UUID | Creator user ID | JWT token or self |
| `updatedBy` | UUID | Last updater user ID | JWT token or self |
| `status` | Enum | User status | `ACTIVE` (default) |
| `temporaryPassword` | Boolean | Password type flag | `true` (default) |

### Complex Object Fields

#### Tenant-Cohort-Role Mapping (`tenantCohortRoleMapping`)

```json
{
  "tenantCohortRoleMapping": [
    {
      "tenantId": "uuid", // Optional: Tenant identifier
      "cohortIds": ["uuid1", "uuid2"], // Optional: Array of cohort UUIDs
      "roleId": "uuid" // Optional: Role identifier
    }
  ]
}
```

**Validation Rules:**
- If `cohortIds` provided, `academicyearid` header is required
- Tenant must exist in database
- Role must exist and belong to the specified tenant
- Cohorts must exist in the specified academic year
- No duplicate `tenantId` values allowed

#### Automatic Member (`automaticMember`)

```json
{
  "automaticMember": {
    "value": true, // Boolean: Enable automatic membership
    "fieldId": "uuid", // UUID: Field identifier
    "fieldName": "string" // String: Field name
  }
}
```

**Business Rule:** Cannot be `true` when `cohortIds` are specified in `tenantCohortRoleMapping`

#### Custom Fields (`customFields`)

```json
{
  "customFields": [
    {
      "fieldId": "uuid", // UUID: Field identifier
      "value": "string" // String: Field value
    }
  ]
}
```

**Validation Rules:**
- Field must exist in the system
- Field must be valid for the user's role/context
- No duplicate `fieldId` values allowed
- Values must pass field-specific validation

## Validation Rules

### Email Validation
- **Pattern**: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`
- **Error**: "Invalid email address"

### Mobile Validation
- **Pattern**: Exactly 10 digits
- **Error**: "Mobile number must be 10 digits long"

### Date of Birth Validation
- **Pattern**: `YYYY-MM-DD` format
- **Rule**: Cannot be in the future
- **Error**: "Date of birth must be in the format yyyy-mm-dd" or "The birth date cannot be in the future"

### UUID Validation
- All ID fields must be valid UUIDs
- **Error**: "Please enter valid UUID"

## Workflow Steps

### 1. JWT Token Extraction
- Extracts `sub` (subject) from Authorization header
- Sets `createdBy` and `updatedBy` fields

### 2. Custom Fields Validation
- Validates field existence
- Checks for duplicate field IDs
- Validates field values against field definitions
- Ensures fields are valid for user's role

### 3. Request Body Validation
- Validates core field formats (email, mobile, dob)
- Checks tenant existence
- Validates academic year for tenant
- Verifies cohort existence in academic year
- Validates role existence and tenant association

### 4. Business Logic Validation
- Prevents automatic member + cohort assignment combination
- Checks for duplicate tenant IDs

### 5. User Existence Check
- Checks Keycloak for existing username/email
- Prevents duplicate user creation

### 6. Keycloak User Creation
- Creates user in Keycloak authentication service
- Handles various error scenarios (409 for duplicates, etc.)

### 7. Database User Creation
- Saves user to PostgreSQL database
- Generates enrollment ID automatically

### 8. Mapping Creation
- Creates tenant-cohort-role mappings OR
- Creates automatic member mappings

### 9. Custom Fields Processing
- Saves custom field values
- Links to user record

### 10. Event Publishing
- Publishes user creation event to Kafka (asynchronous)

## Response Formats

### Success Response (201 Created)
```json
{
  "id": "api.user.create",
  "ver": "1.0",
  "ts": "2024-01-15T10:30:00.000Z",
  "params": {
    "resmsgid": "uuid",
    "status": "successful",
    "err": null,
    "errmsg": null,
    "successmessage": "User created successfully"
  },
  "responseCode": 201,
  "result": {
    "userData": {
      "userId": "uuid",
      "username": "john.doe",
      "firstName": "John",
      "lastName": "Doe",
      "email": "john@example.com",
      "createFailures": []
    }
  }
}
```

### Error Response Examples

#### 400 Bad Request - Validation Error
```json
{
  "id": "api.user.create",
  "ver": "1.0",
  "ts": "2024-01-15T10:30:00.000Z",
  "params": {
    "resmsgid": "uuid",
    "status": "failed",
    "err": "Invalid email address",
    "errmsg": "Bad Request"
  },
  "responseCode": 400,
  "result": {}
}
```

#### 409 Conflict - User Exists
```json
{
  "id": "api.user.create",
  "ver": "1.0",
  "ts": "2024-01-15T10:30:00.000Z",
  "params": {
    "resmsgid": "uuid",
    "status": "failed",
    "err": "User already exist.",
    "errmsg": "Bad Request"
  },
  "responseCode": 400,
  "result": {}
}
```

## Edge Cases and Error Scenarios

### 1. Missing Password
- **Error**: "User cannot be created, Password missing"
- **Status**: 500 Internal Server Error

### 2. Invalid UUID Fields
- **Error**: "Please enter valid UUID"
- **Status**: 400 Bad Request

### 3. Automatic Member + Cohort Assignment
- **Error**: "Invalid operation: A user cannot be assigned as an automatic member while also being assigned to a center simultaneously"
- **Status**: 400 Bad Request

### 4. Duplicate Tenant ID
- **Error**: "Duplicate tenantId detected. Please ensure each tenantId is unique and correct your data."
- **Status**: 400 Bad Request

### 5. Academic Year Required
- **Error**: "Academic Year ID is required when a Cohort ID is provided."
- **Status**: 400 Bad Request

### 6. Keycloak Service Unavailable
- **Error**: "No response received from Keycloak"
- **Status**: 500 Internal Server Error

### 7. Email Already Exists in Keycloak
- **Error**: "Email already exists {email}"
- **Status**: 409 Conflict

### 8. Invalid Custom Fields for Role
- **Error**: "The following fields are not valid for this user: {fieldIds}"
- **Status**: 400 Bad Request

## Performance Considerations

The API includes performance monitoring with step-by-step timing:
- JWT Extraction
- Custom Fields Validation
- Request Validation
- Business Logic Validation
- Keycloak User Check
- Keycloak User Creation
- Database User Creation
- Custom Fields Processing

Total execution time and breakdown are logged for monitoring purposes.

## Security Features

1. **Password Handling**: Passwords are securely transmitted to Keycloak
2. **JWT Integration**: Supports JWT token context for audit trails
3. **Input Sanitization**: All inputs are validated and sanitized
4. **UUID Validation**: Prevents injection attacks through ID fields
5. **Business Rule Enforcement**: Prevents invalid state combinations

## Integration Points

1. **Keycloak**: User authentication and authorization
2. **PostgreSQL**: User data persistence
3. **Kafka**: Event publishing for downstream services
4. **Notification Service**: Email/SMS notifications (if configured)
5. **Academic Year Service**: Academic year validation
6. **Tenant Service**: Tenant validation
7. **Role Service**: Role validation and assignment
8. **Cohort Service**: Cohort validation and membership
9. **Fields Service**: Custom field validation and storage 